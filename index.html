<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BatiDevis Pro - Solution BTP</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] } } } }
    </script>

    <style>
        body { background-color: #f1f5f9; color: #1e293b; font-family: 'Inter', sans-serif; }
        .input-std { width: 100%; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; margin-bottom: 10px; font-size: 14px; }
        .label-std { font-size: 11px; font-weight: 700; text-transform: uppercase; color: #64748b; display: block; margin-bottom: 4px; }
        
        /* Print styles */
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .print-area { position: absolute; top: 0; left: 0; width: 100%; margin: 0; box-shadow: none; }
            @page { margin: 0; size: A4; }
        }
    </style>
</head>
<body>

    <div id="rescue-mode" style="padding: 20px; text-align: center; background: #fee2e2; border-bottom: 1px solid #ef4444;">
        <p style="color: #b91c1c; font-weight: bold;">Si l'√©cran reste blanc en dessous, cliquez sur ce bouton :</p>
        <button onclick="localStorage.clear(); window.location.reload();" style="background: #dc2626; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px; font-weight: bold;">
            R√âPARER L'APPLICATION (VIDER LE CACHE)
        </button>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        // --- PROTECTION DES DONNEES ---
        const safeData = (key, def) => {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : def;
            } catch (e) { return def; }
        };

        const { useState, useEffect, useRef } = React;

        // --- APPLICATION ---
        const App = () => {
            // --- STATE ---
            const [tab, setTab] = useState('editor'); 
            const [docType, setDocType] = useState('quote');
            
            // Donn√©es avec valeurs par d√©faut forc√©es
            const [company, setCompany] = useState(safeData('bd_company', { 
                name: "MON ENTREPRISE BTP", address: "Abidjan", city: "Abidjan", phone: "", email: "", siret: "", bank: "", logoUrl: "", defaultTva: 18 
            }));
            const [client, setClient] = useState(safeData('bd_client', { name: "Client", phone: "", city: "Abidjan" }));
            const [items, setItems] = useState(safeData('bd_items', [{id:1, description:"Prestation 1", qty:1, price:10000, unit:"U"}]));
            const [quoteInfo, setQuoteInfo] = useState(safeData('bd_info', { number: "DEV-001", date: new Date().toISOString().split('T')[0] }));

            const fileInputRef = useRef(null);

            // Cacher le mode secours si l'app se charge bien
            useEffect(() => {
                const rescue = document.getElementById('rescue-mode');
                if(rescue) rescue.style.display = 'none';
            }, []);

            // Sauvegarde
            useEffect(() => {
                localStorage.setItem('bd_company', JSON.stringify(company));
                localStorage.setItem('bd_client', JSON.stringify(client));
                localStorage.setItem('bd_items', JSON.stringify(items));
                localStorage.setItem('bd_info', JSON.stringify(quoteInfo));
            }, [company, client, items, quoteInfo]);

            // Calculs
            const formatPrice = (p) => new Intl.NumberFormat('fr-CI', { style: 'currency', currency: 'XOF', maximumFractionDigits: 0 }).format(p || 0);
            const totalHT = items.reduce((acc, i) => acc + ((i.qty || 0) * (i.price || 0)), 0);
            const tva = (company.defaultTva || 0);
            const totalTTC = totalHT * (1 + tva/100);

            // Actions
            const handleLogo = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setCompany({...company, logoUrl: reader.result});
                    reader.readAsDataURL(file);
                }
            };

            const handleWhatsApp = () => {
                const num = client.phone ? client.phone.replace(/[^0-9]/g, '') : "";
                if(!num) return alert("Entrez un num√©ro client");
                const msg = `Bonjour ${client.name}, voici le document ${quoteInfo.number} de ${formatPrice(totalTTC)}.`;
                window.open(`https://wa.me/${num}?text=${encodeURIComponent(msg)}`, '_blank');
            };

            // Rendu
            const themeColor = docType === 'quote' ? 'bg-orange-600' : docType === 'invoice' ? 'bg-blue-600' : 'bg-emerald-600';
            const themeText = docType === 'quote' ? 'text-orange-600' : docType === 'invoice' ? 'text-blue-600' : 'text-emerald-600';

            return (
                <div className="flex flex-col lg:flex-row min-h-screen">
                    
                    {/* --- GAUCHE : MENU & CONTROLE --- */}
                    <div className="w-full lg:w-[400px] bg-white border-r shadow-xl z-10 no-print flex flex-col h-screen overflow-hidden">
                        <div className="p-4 bg-slate-800 text-white flex justify-between items-center shrink-0">
                            <h1 className="font-bold text-lg">üèóÔ∏è BatiDevis</h1>
                            <div className="flex gap-2">
                                <button onClick={() => setTab('editor')} className={`px-3 py-1 rounded text-xs ${tab==='editor' ? 'bg-blue-500' : 'bg-slate-700'}`}>√âditeur</button>
                                <button onClick={() => setTab('settings')} className={`px-3 py-1 rounded text-xs ${tab==='settings' ? 'bg-blue-500' : 'bg-slate-700'}`}>Entreprise</button>
                            </div>
                        </div>

                        <div className="p-4 overflow-y-auto flex-1">
                            {/* ONGLET PARAMETRES */}
                            {tab === 'settings' && (
                                <div>
                                    <h2 className="font-bold mb-4 text-slate-700 border-b pb-2">Mon Entreprise</h2>
                                    
                                    <div className="mb-4 flex items-center gap-3 cursor-pointer bg-slate-50 p-2 rounded border" onClick={() => fileInputRef.current.click()}>
                                        {company.logoUrl ? <img src={company.logoUrl} className="h-12 w-12 object-contain" /> : <div className="h-12 w-12 bg-slate-200 flex items-center justify-center text-xs">Logo</div>}
                                        <span className="text-blue-600 text-xs font-bold underline">Changer le logo</span>
                                        <input type="file" ref={fileInputRef} className="hidden" onChange={handleLogo} />
                                    </div>

                                    <label className="label-std">Nom Entreprise</label>
                                    <input className="input-std" value={company.name} onChange={e => setCompany({...company, name: e.target.value})} />
                                    
                                    <label className="label-std">Adresse</label>
                                    <input className="input-std" value={company.address} onChange={e => setCompany({...company, address: e.target.value})} />
                                    
                                    <label className="label-std">Ville / Pays</label>
                                    <input className="input-std" value={company.city} onChange={e => setCompany({...company, city: e.target.value})} />
                                    
                                    <div className="flex gap-2">
                                        <div className="flex-1"><label className="label-std">T√©l√©phone</label><input className="input-std" value={company.phone} onChange={e => setCompany({...company, phone: e.target.value})} /></div>
                                        <div className="flex-1"><label className="label-std">Email</label><input className="input-std" value={company.email} onChange={e => setCompany({...company, email: e.target.value})} /></div>
                                    </div>

                                    <label className="label-std">RCCM / CC</label>
                                    <input className="input-std" value={company.siret} onChange={e => setCompany({...company, siret: e.target.value})} />

                                    <label className="label-std">Infos Bancaires (RIB)</label>
                                    <textarea className="input-std" rows="3" value={company.bank} onChange={e => setCompany({...company, bank: e.target.value})}></textarea>

                                    <div className="mt-4 border-t pt-4">
                                        <label className="label-std text-blue-600">TVA par d√©faut (%)</label>
                                        <input type="number" className="input-std font-bold" value={company.defaultTva} onChange={e => setCompany({...company, defaultTva: parseFloat(e.target.value)})} />
                                    </div>

                                    <button onClick={() => setTab('editor')} className="w-full bg-slate-800 text-white py-3 rounded font-bold mt-4">Sauvegarder</button>
                                </div>
                            )}

                            {/* ONGLET EDITEUR */}
                            {tab === 'editor' && (
                                <div>
                                    <div className="flex bg-slate-100 p-1 rounded mb-4">
                                        <button onClick={() => setDocType('quote')} className={`flex-1 py-1 text-xs font-bold rounded ${docType === 'quote' ? 'bg-white shadow' : ''}`}>Devis</button>
                                        <button onClick={() => setDocType('invoice')} className={`flex-1 py-1 text-xs font-bold rounded ${docType === 'invoice' ? 'bg-white shadow' : ''}`}>Facture</button>
                                        <button onClick={() => setDocType('receipt')} className={`flex-1 py-1 text-xs font-bold rounded ${docType === 'receipt' ? 'bg-white shadow' : ''}`}>Re√ßu</button>
                                    </div>

                                    <div className="bg-white border p-3 rounded mb-4">
                                        <label className="label-std text-blue-600">Client</label>
                                        <input className="input-std" placeholder="Nom Client" value={client.name} onChange={e => setClient({...client, name: e.target.value})} />
                                        <div className="flex gap-2">
                                            <input className="input-std" placeholder="T√©l" value={client.phone} onChange={e => setClient({...client, phone: e.target.value})} />
                                            <input className="input-std" placeholder="Ville" value={client.city} onChange={e => setClient({...client, city: e.target.value})} />
                                        </div>
                                        <div className="flex gap-2 border-t pt-2 mt-2">
                                            <input className="input-std" placeholder="N¬∞ Doc" value={quoteInfo.number} onChange={e => setQuoteInfo({...quoteInfo, number: e.target.value})} />
                                            <input type="date" className="input-std" value={quoteInfo.date} onChange={e => setQuoteInfo({...quoteInfo, date: e.target.value})} />
                                        </div>
                                    </div>

                                    <div className="mb-2 flex justify-between items-center">
                                        <span className="font-bold text-sm">Prestations</span>
                                        <button onClick={() => setItems([...items, {id:Date.now(), description:"", qty:1, price:0, unit:"U"}])} className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold">+ Ajouter</button>
                                    </div>

                                    <div className="space-y-2">
                                        {items.map(item => (
                                            <div key={item.id} className="border p-2 rounded bg-slate-50">
                                                <input className="input-std mb-1" placeholder="Description" value={item.description} onChange={e => setItems(items.map(i => i.id === item.id ? {...i, description: e.target.value} : i))} />
                                                <div className="flex gap-2">
                                                    <input type="number" className="input-std w-16 text-center" placeholder="Qt√©" value={item.qty} onChange={e => setItems(items.map(i => i.id === item.id ? {...i, qty: e.target.value} : i))} />
                                                    <select className="input-std w-16" value={item.unit} onChange={e => setItems(items.map(i => i.id === item.id ? {...i, unit: e.target.value} : i))}><option>U</option><option>m¬≤</option><option>Ens</option></select>
                                                    <input type="number" className="input-std text-right" placeholder="Prix" value={item.price} onChange={e => setItems(items.map(i => i.id === item.id ? {...i, price: e.target.value} : i))} />
                                                    <button onClick={() => setItems(items.filter(i => i.id !== item.id))} className="text-red-500 px-2">X</button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="p-3 bg-white border-t shrink-0 space-y-2">
                            <button onClick={handleWhatsApp} className="w-full py-2 bg-green-500 text-white rounded font-bold shadow">WhatsApp</button>
                            <button onClick={() => window.print()} className={`w-full py-2 text-white rounded font-bold shadow ${themeColor}`}>Imprimer PDF</button>
                        </div>
                    </div>

                    {/* --- DROITE : APERCU A4 --- */}
                    <div className="flex-1 bg-slate-200 p-8 overflow-y-auto flex justify-center items-start">
                        <div className="print-area bg-white shadow-2xl w-[21cm] min-h-[29.7cm] p-[1.5cm] relative flex flex-col">
                            
                            {/* Header */}
                            <div className="flex justify-between items-start mb-8 border-b pb-6">
                                <div className="w-1/2">
                                    {company.logoUrl ? <img src={company.logoUrl} className="h-20 object-contain mb-2" /> : <div className={`h-12 w-12 ${themeColor} rounded text-white flex items-center justify-center font-bold mb-2`}>B</div>}
                                    <h1 className="font-bold text-lg uppercase">{company.name}</h1>
                                    <div className="text-xs text-slate-500">
                                        <p>{company.address}</p>
                                        <p>{company.city}</p>
                                        <p>{company.phone} - {company.email}</p>
                                    </div>
                                </div>
                                <div className="text-right w-1/2">
                                    <h2 className={`text-4xl font-black ${themeText} uppercase`}>
                                        {docType === 'quote' ? 'DEVIS' : docType === 'invoice' ? 'FACTURE' : 'RE√áU'}
                                    </h2>
                                    <p className="font-mono text-sm mt-1">N¬∞ {quoteInfo.number}</p>
                                    <p className="text-sm mt-1">Date: {new Date(quoteInfo.date).toLocaleDateString('fr-FR')}</p>
                                    
                                    <div className="mt-4 bg-slate-50 p-3 rounded text-left inline-block w-48 border">
                                        <p className="text-[10px] font-bold text-slate-400 uppercase">Client</p>
                                        <p className="font-bold">{client.name}</p>
                                        <p className="text-xs">{client.phone}</p>
                                        <p className="text-xs">{client.city}</p>
                                    </div>
                                </div>
                            </div>

                            {/* Table */}
                            <table className="w-full mb-8">
                                <thead>
                                    <tr className="border-b-2 border-slate-200">
                                        <th className="text-left py-2 text-xs font-bold uppercase text-slate-500">Description</th>
                                        <th className="text-center py-2 text-xs font-bold uppercase text-slate-500">Qt√©</th>
                                        <th className="text-right py-2 text-xs font-bold uppercase text-slate-500">P.U.</th>
                                        <th className="text-right py-2 text-xs font-bold uppercase text-slate-500">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {items.map(item => (
                                        <tr key={item.id} className="border-b border-slate-50">
                                            <td className="py-3 text-sm font-medium">{item.description}</td>
                                            <td className="py-3 text-center text-sm">{item.qty} {item.unit}</td>
                                            <td className="py-3 text-right text-sm font-mono">{formatPrice(item.price)}</td>
                                            <td className="py-3 text-right text-sm font-bold">{formatPrice((item.qty || 0) * (item.price || 0))}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>

                            {/* Totals */}
                            <div className="flex justify-end mb-12">
                                <div className="w-1/2 space-y-2 text-right">
                                    <div className="flex justify-between text-sm text-slate-500"><span>Total HT</span><span>{formatPrice(totalHT)}</span></div>
                                    <div className="flex justify-between text-sm text-slate-500 border-b pb-2"><span>TVA ({tva}%)</span><span>{formatPrice(totalHT * tva/100)}</span></div>
                                    <div className={`flex justify-between items-center p-3 rounded font-bold text-lg ${docType==='quote'?'bg-orange-50 text-orange-900':docType==='invoice'?'bg-blue-50 text-blue-900':'bg-emerald-50 text-emerald-900'}`}>
                                        <span>NET √Ä PAYER</span>
                                        <span>{formatPrice(totalTTC)}</span>
                                    </div>
                                </div>
                            </div>

                            {/* Footer */}
                            <div className="mt-auto">
                                {(docType === 'invoice' && company.bank) && (
                                    <div className="mb-4 p-3 border rounded bg-slate-50">
                                        <p className="text-xs font-bold text-slate-500 uppercase">Infos Paiement</p>
                                        <p className="text-xs font-mono whitespace-pre-wrap">{company.bank}</p>
                                    </div>
                                )}
                                <div className="border-t pt-4 text-center">
                                    <p className="text-[10px] font-bold text-slate-400 uppercase">{company.name} - {company.siret}</p>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
